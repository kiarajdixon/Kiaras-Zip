<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Let's Play Zip!</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <main class="wrap">
    <section class="card">
      <!-- AUTH SECTION (shown when not logged in) -->
      <div id="authSection" class="auth-container">
        <h1>Let's Play Zip!</h1>
        

        <div class="auth-tabs">
          <button class="auth-tab active" data-tab="login">Sign In</button>
          <button class="auth-tab" data-tab="register">Register</button>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="auth-form active">
          <input type="text" id="loginUsername" placeholder="Username" required autocomplete="username" />
          <input type="password" id="loginPassword" placeholder="Password" required autocomplete="current-password" />
          <button type="submit" class="btn-primary">Sign In</button>
          <div id="loginMessage" class="auth-message"></div>
        </form>

        <!-- Register Form -->
        <form id="registerForm" class="auth-form">
          <input type="text" id="registerUsername" placeholder="Choose a username" required autocomplete="username" />
          <input type="password" id="registerPassword" placeholder="Choose a password" required autocomplete="new-password" />
          <input type="password" id="registerConfirm" placeholder="Confirm password" required autocomplete="new-password" />
          <button type="submit" class="btn-primary">Create Account</button>
          <div id="registerMessage" class="auth-message"></div>
        </form>
      </div>

      <!-- GAME SECTION (shown when logged in) -->
      <div id="gameSection" class="hidden">
        <div class="user-header">
          <span class="user-info">Welcome, <strong id="currentUsername"></strong>!</span>
          <div style="display:flex;gap:8px">
            <a href="rankings.html" class="btn-logout">Rankings</a>
            <button id="logoutBtn" class="btn-logout">Logout</button>
          </div>
        </div>

        <h1>Let's Play Zip!</h1>
        <p class="subtitle">Drag from 1 → 2 → 3 → … Cover every cell!</p>

        <div id="dashboard" class="dashboard"></div>

        <div class="list" id="zipList">
          <span class="msg">Loading zips…</span>
        </div>
      </div>
    </section>
  </main>

  <script>
    // =====================
    // Auth State Management
    // =====================
    function getCurrentUser() {
      return localStorage.getItem("zip_currentUser");
    }

    function setCurrentUser(username) {
      if (username) {
        localStorage.setItem("zip_currentUser", username);
      } else {
        localStorage.removeItem("zip_currentUser");
      }
      updateUI();
    }

    function getUserData(user) {
      if (!user) return { opened: {}, completed: {}, startTimes: {}, times: {} };
      const raw = localStorage.getItem(`zip_user_${user}`);
      try {
        return raw ? JSON.parse(raw) : { opened: {}, completed: {}, startTimes: {}, times: {} };
      } catch {
        return { opened: {}, completed: {}, startTimes: {}, times: {} };
      }
    }

    function saveUserData(user, data) {
      if (!user) return;
      localStorage.setItem(`zip_user_${user}`, JSON.stringify(data));
    }

    function markOpenedForUser(user, id) {
      if (!user) return;
      const d = getUserData(user);
      d.opened = d.opened || {};
      d.opened[id] = true;
      saveUserData(user, d);
    }

    // =====================
    // UI Updates
    // =====================
    function updateUI() {
      const user = getCurrentUser();
      const authSection = document.getElementById('authSection');
      const gameSection = document.getElementById('gameSection');
      
      if (user) {
        authSection.classList.add('hidden');
        gameSection.classList.remove('hidden');
        document.getElementById('currentUsername').textContent = user;
        loadZips();
      } else {
        authSection.classList.remove('hidden');
        gameSection.classList.add('hidden');
      }
    }

    function showMessage(elementId, message, isError = true) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = 'auth-message ' + (isError ? 'error' : 'success');
    }

    function clearMessages() {
      document.querySelectorAll('.auth-message').forEach(el => {
        el.className = 'auth-message';
        el.textContent = '';
      });
    }

    // =====================
    // Auth Tab Switching
    // =====================
    document.querySelectorAll('.auth-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        
        // Update tab styles
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Show correct form
        document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
        document.getElementById(targetTab + 'Form').classList.add('active');
        
        clearMessages();
      });
    });

    // =====================
    // Login Handler
    // =====================
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessages();
      
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      if (!username || !password) {
        showMessage('loginMessage', 'Please enter username and password');
        return;
      }

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (res.ok) {
          setCurrentUser(username);
          return;
        }

        if (res.status === 404) {
          showMessage('loginMessage', 'User not found. Please register first!');
          return;
        }

        if (res.status === 401) {
          showMessage('loginMessage', 'Wrong password. Please try again.');
          return;
        }

        showMessage('loginMessage', 'Login failed. Please try again.');
      } catch (err) {
        console.error('Login error:', err);
        showMessage('loginMessage', 'Server error. Make sure the server is running.');
      }
    });

    // =====================
    // Register Handler
    // =====================
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessages();
      
      const username = document.getElementById('registerUsername').value.trim();
      const password = document.getElementById('registerPassword').value;
      const confirm = document.getElementById('registerConfirm').value;
      
      if (!username || !password) {
        showMessage('registerMessage', 'Please fill in all fields');
        return;
      }

      if (username.length < 3) {
        showMessage('registerMessage', 'Username must be at least 3 characters');
        return;
      }

      if (password.length < 4) {
        showMessage('registerMessage', 'Password must be at least 4 characters');
        return;
      }

      if (password !== confirm) {
        showMessage('registerMessage', 'Passwords do not match');
        return;
      }

      try {
        const res = await fetch('/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (res.ok) {
          showMessage('registerMessage', 'Account created! You can now sign in.', false);
          // Clear register form
          document.getElementById('registerUsername').value = '';
          document.getElementById('registerPassword').value = '';
          document.getElementById('registerConfirm').value = '';
          // Switch to login tab after 1.5s
          setTimeout(() => {
            document.querySelector('[data-tab="login"]').click();
            document.getElementById('loginUsername').value = username;
            document.getElementById('loginUsername').focus();
          }, 1500);
          return;
        }

        if (res.status === 409) {
          showMessage('registerMessage', 'Username already exists. Choose another.');
          return;
        }

        const data = await res.json().catch(() => ({}));
        showMessage('registerMessage', data.error || 'Registration failed');
      } catch (err) {
        console.error('Register error:', err);
        showMessage('registerMessage', 'Server error. Make sure the server is running.');
      }
    });

    // =====================
    // Logout Handler
    // =====================
    document.getElementById('logoutBtn').addEventListener('click', () => {
      setCurrentUser(null);
    });

    // =====================
    // Load Puzzles
    // =====================
    async function loadZips() {
      const list = document.getElementById("zipList");
      list.innerHTML = `<span class="msg">Loading zips…</span>`;

      try {
        const res = await fetch("puzzles.json", { cache: "no-store" });
        if (!res.ok) throw new Error(`Failed to load puzzles.json (${res.status})`);

        const data = await res.json();
        const zips = Array.isArray(data.zips) ? data.zips.slice() : [];
        zips.sort((a, b) => (Number(a.id) || 0) - (Number(b.id) || 0));

        list.innerHTML = "";

        if (zips.length === 0) {
          list.innerHTML = `<span class="msg bad">No zips found</span>`;
          return;
        }

        const currentUser = getCurrentUser();
        const userData = getUserData(currentUser);

        // Render dashboard
        const dash = document.getElementById("dashboard");

        function fmtMs(ms) {
          if (ms == null) return "—";
          const s = Math.floor(ms / 1000);
          return `${s}s`;
        }

        // Prepare completed times
        const completedEntries = [];
        for (const zidStr of Object.keys(userData.times || {})) {
          const zid = Number(zidStr);
          const ms = userData.times[zidStr];
          const meta = zips.find(z => Number(z.id) === zid);
          const n = Array.isArray(meta?.grid) ? meta.grid.length : null;
          const numbersCount = meta ? meta.grid.flat().filter(x => x !== 0).length : null;
          if (ms != null && meta) completedEntries.push({ id: zid, ms, n, numbersCount });
        }

        // Stats
        const timesSorted = completedEntries.map(e => e.ms).sort((a, b) => a - b);
        const avg = timesSorted.length ? Math.round(timesSorted.reduce((a, b) => a + b, 0) / timesSorted.length) : null;
        const median = timesSorted.length ? (timesSorted.length % 2 === 1 ? timesSorted[(timesSorted.length - 1) / 2] : Math.round((timesSorted[timesSorted.length / 2 - 1] + timesSorted[timesSorted.length / 2]) / 2)) : null;

        dash.innerHTML = `
          <div class="title">Your Stats</div>
          <div class="row">
            <div class="stat">Average: ${fmtMs(avg)}</div>
            <div class="stat">Median: ${fmtMs(median)}</div>
            <div class="stat">Completed: ${timesSorted.length} / ${zips.length}</div>
          </div>
        `;

        // Render puzzle buttons
        for (const z of zips) {
          const n = Array.isArray(z.grid) ? z.grid.length : 0;
          const a = document.createElement("a");
          a.className = "btn";
          a.href = `zip.html?id=${encodeURIComponent(z.id)}`;
          a.dataset.id = String(z.id);
          a.textContent = `Zip #${z.id}${n ? ` (${n}×${n})` : ""}`;

          if (userData.opened && userData.opened[z.id]) a.classList.add("seen");
          if (userData.completed && userData.completed[z.id]) a.classList.add("completed");

          a.addEventListener("click", () => {
            const user = getCurrentUser();
            if (user) markOpenedForUser(user, z.id);
          });

          list.appendChild(a);
        }
      } catch (err) {
        console.error(err);
        list.innerHTML = `<span class="msg bad">Could not load puzzles. Make sure server is running.</span>`;
      }
    }

    // =====================
    // Initialize
    // =====================
    document.addEventListener('DOMContentLoaded', () => {
      updateUI();
    });
  </script>
</body>
</html>
